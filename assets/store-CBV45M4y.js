import{M as Qe,S as Ue,b as Xe}from"./index-B_CgAQ6L.js";import{g as Ye,a as et,b as tt,c as nt}from"./index-Bb02P9SZ.js";function rt(e,t){for(const n in e)t(e[n],n)}function N(e,t){e.forEach(t)}function M(e,t,n){if(!e)throw Error(`${n?n+": ":""}${t}`)}function L({node:e=[],from:t,source:n,parent:a=t||n,to:r,target:o,child:i=r||o,scope:c={},meta:u={},family:s={type:"regular"},regional:b}={}){const y=te(a),m=te(s.links),g=te(s.owners),l=[];N(e,h=>h&&E(l,h));const d={id:mt(),seq:l,next:te(i),meta:u,scope:c,family:{type:s.type||"crosslink",links:m,owners:g}};return N(m,h=>E(le(h),d)),N(g,h=>E(de(h),d)),N(y,h=>E(h.next,d)),b&&V&&_e(K(V),[d]),d}function U(e,t,n){let a,r=R,o=null,i=$;if(e.target&&(t=e.params,n=e.defer,a=e.meta,r="page"in e?e.page:r,e.stack&&(o=e.stack),i=C(e)||i,e=e.target),i&&$&&i!==$&&($=null),Array.isArray(e))for(let l=0;l<e.length;l++)q("pure",r,D(e[l]),o,t[l],i,a);else q("pure",r,D(e),o,t,i,a);if(n&&!ne)return;const c={isRoot:ne,currentPage:R,scope:$,isWatch:ae,isPure:oe};let u,s,b,y,m,g;ne=0;e:for(;y=At();){const{idx:l,stack:d,type:h}=y;b=d.node,R=m=d.page,$=C(d),m?g=m.reg:$&&(g=$.reg);const f=!!m,v=!!$,k={fail:0,scope:b.scope};u=s=0;for(let x=l;x<b.seq.length&&!u;x++){const S=b.seq[x];if(S.order){const{priority:w,barrierID:p}=S.order,A=p?m?`${m.fullID}_${p}`:p:0;if(x!==l||h!==w){p?ve.has(A)||(ve.add(A),Se(x,d,w,p)):Se(x,d,w,0);continue e}p&&ve.delete(A)}switch(S.type){case"mov":{const p=S.data;let A;switch(p.from){case"stack":A=K(d);break;case"a":case"b":A=d[p.from];break;case"value":A=p.store;break;case"store":if(g&&!g[p.store.id])if(f){const he=Ge(m,p.store.id);d.page=m=he,he?g=he.reg:v?(G($,p.store,0,1,p.softRead),g=$.reg):g=void 0}else v&&G($,p.store,0,1,p.softRead);A=je(g&&g[p.store.id]||p.store)}switch(p.to){case"stack":d.value=A;break;case"a":case"b":d[p.to]=A;break;case"store":Mt(m,$,p.target,0).current=A}break}case"compute":const w=S.data;if(w.fn){ae=b.meta.op==="watch",oe=w.pure;const p=w.safe?(0,w.fn)(K(d),k.scope,d):Nt(k,w.fn,d);w.filter?s=!p:d.value=p,ae=c.isWatch,oe=c.isPure}}u=k.fail||s}if(!u){const x=K(d),S=C(d);if(N(b.next,w=>{q("child",m,w,d,x,S)}),S){b.meta.needFxCounter&&q("child",m,S.fxCount,d,x,S),b.meta.storeChange&&q("child",m,S.storeChange,d,x,S),b.meta.warnSerialize&&q("child",m,S.warnSerializeNode,d,x,S);const w=S.additionalLinks[b.id];w&&N(w,p=>{q("child",m,p,d,x,S)})}}}ne=c.isRoot,R=c.currentPage,$=C(c)}function at(e,t){let n,a;const r=e;if(t){const o=lt(t);e.length===0?(n=o.path,a=o.fullName):(n=o.path.concat([e]),a=o.fullName.length===0?e:o.fullName+"/"+e)}else n=e.length===0?[]:[e],a=e;return{shortName:r,fullName:a,path:n}}function Me(e,t){if(!t||!t.name&&!t.named&&!t.loc)return e;let n=`[${e}]`;const a=t.named||t.name;a&&(n+=` unit '${a}'`);const r=t.loc;return!a&&r&&(n+=` (${r.file}:${r.line}:${r.column})`),n}function ke(e){const t=()=>e();return t.unsubscribe=()=>e(),t}function J(e,...t){const n=Ve();if(n){const a=n.handlers[e];if(a)return a(n,...t)}}function _(e,t){const n=Z({or:t,and:typeof e=="string"?{name:e}:e}),a=Me("event",n),r=(c,...u)=>(M(!O(r,"derived"),"call of derived event is not supported, use createEvent instead",a),M(!oe,"unit call from pure function is not supported, use operators like sample instead",a),R?((s,b,y,m)=>{const g=R;let l=null;if(b)for(l=R;l&&l.template!==b;)l=j(l);qe(l);const d=s.create(y,m);return qe(g),d})(r,o,c,u):r.create(c,u)),o=Ve(),i=Object.assign(r,{graphite:L({meta:Je(n.actualOp||"event",r,n),regional:1}),create:c=>(U({target:r,params:c,scope:$}),c),watch:c=>He(r,c),map:c=>be(r,"map",c,[T()]),filter:c=>be(r,"filter",c.fn?c:c.fn,[T(pe,1)]),filterMap:c=>be(r,"filterMap",c,[T(),W(u=>!Q(u),1)]),prepend(c){M(r.targetable,".prepend of derived event is not supported, call source event instead",a);const u=_("* → "+r.shortName,{parent:j(r)});return J("eventPrepend",D(u)),Re(u,r,[T()],"prepend",c),zt(r,u),u}});return n!=null&&n.domain&&n.domain.hooks.event(i),B(i,"id",i.graphite.id),Pe(i.graphite),i}function De(e,t,n,a,r){return bt(n,`${r} ${t}`,"first argument"),M(z(a),"second argument should be a function",r),ce(!O(e,"derived"),`${t} in derived store`,`${t} in store created via createStore`,r),N(Array.isArray(n)?n:[n],o=>{e.off(o),ie(e).set(o,Ze(Ke(o,e,"on",kt,a)))}),e}function I(e,t){const n=Z(t),a=wt(e),r=Me("store",n),o=_({named:"updates",derived:1});J("storeBase",a);const i=a.id,c="skipVoid"in n,u=c&&!n.skipVoid;ce(!(c&&n.skipVoid),"{skipVoid: true}","updateFilter",r);const s={subscribers:new Map,updates:o,defaultState:e,stateRef:a,getState(){let f,v=a;if(R){let k=R;for(;k&&!k.reg[i];)k=j(k);k&&(f=k)}return!f&&$&&(G($,a,1),f=$),f&&(v=f.reg[i]),je(v)},setState:f=>U({target:s,params:f,defer:1,scope:$}),reset:(...f)=>(M(s.targetable,".reset of derived store is not supported",r),N(f,v=>De(s,".reset",v,()=>s.defaultState,r)),s),on:(f,v)=>(M(s.targetable,".on of derived store is not supported",r),De(s,".on",f,v,r)),off(f){const v=ie(s).get(f);return v&&(v(),ie(s).delete(f)),s},map(f,v){let k,x;F(f)&&(k=f,f=f.fn);const S=s.getState(),w=Q(S);(!w||w&&u)&&(x=f(S));const p=I(x,{name:`${s.shortName} → *`,derived:1,...v,and:k}),A=Ke(s,p,"map",pe,f);return xt(se(p),{type:"map",fn:f,from:a}),se(p).noInit=1,J("storeMap",a,A),p},watch(f,v){if(ce(!v,"watch second argument","sample",r),!v||!fe(f)){const k=He(s,f);return J("storeWatch",a,f)||f(s.getState()),k}return M(z(v),"second argument should be a function",r),f.watch(k=>v(s.getState(),k))}},b=Je("store",s,n),y=s.defaultConfig.updateFilter;s.graphite=L({scope:{state:a,fn:y},node:[W((f,v,k)=>(k.scope&&!k.scope.reg[a.id]&&(k.b=1),f)),$t(a),W((f,v,{a:k,b:x})=>{const S=Q(f);return S&&!c&&console.error(`${r}: ${ye}`),(S&&u||!S)&&(f!==k||x)},1),y&&T(yt,1),me({from:"stack",target:a})],child:o,meta:{...b,defaultState:e},regional:1}),B(s,"id",s.graphite.id),B(s,"rootStateRefId",i);const m=O(s,"serialize"),g=O(s,"derived"),l=m==="ignore",d=O(s,"sid");d&&(B(s,"storeChange",1),a.sid=d),d||l||g||B(s,"warnSerialize",1);const h=Q(e);return M(g||!h||h&&u,ye,r),g&&h&&!c&&console.error(`${r}: ${ye}`),_e(s,[o]),n!=null&&n.domain&&n.domain.hooks.store(s),g||(s.reinit=_({named:"reinit"}),s.reset(s.reinit)),a.meta=s.graphite.meta,Pe(s.graphite),s}function ot(){const e={};return e.req=new Promise((t,n)=>{e.rs=t,e.rj=n}),e.req.catch(()=>{}),e}function st(e,t={}){const n=Z(z(e)?{handler:e}:e,t),a=Me("effect",n),r=_(z(e)?{handler:e}:e,{...t,actualOp:"effect"}),o=D(r);B(o,"op",r.kind="effect"),r.use=l=>(M(z(l),".use argument should be a function",a),y.scope.handler=l,r),r.use.getCurrent=()=>y.scope.handler;const i=r.finally=_({named:"finally",derived:1}),c=r.done=i.filterMap({named:"done",fn({status:l,params:d,result:h}){if(l==="done")return{params:d,result:h}}}),u=r.fail=i.filterMap({named:"fail",fn({status:l,params:d,error:h}){if(l==="fail")return{params:d,error:h}}}),s=r.doneData=c.map({named:"doneData",fn:({result:l})=>l}),b=r.failData=u.map({named:"failData",fn:({error:l})=>l}),y=L({scope:{handler:r.defaultConfig.handler||(()=>M(0,`no handler used in ${r.compositeName.fullName}`))},node:[W((l,d,h)=>{let f=d.handler;const v=C(h);if(v){const k=v.handlers.unitMap.get(r)||v.handlers.sidMap[r.sid];k&&(f=k)}return l.handler=f,l},0,1),W((l,d,h)=>{if(d.runnerFn&&!d.runnerFn(l,null,h))return;const{params:f,req:v,handler:k,args:x=[f]}=l,S=Fe(f,v,1,i,h),w=Fe(f,v,0,i,h),[p,A]=It(k,w,x);p&&(F(A)&&z(A.then)?A.then(S,w):S(A))},0,1)],meta:{op:"fx",fx:"runner"}});o.scope.runner=y,E(o.seq,W((l,{runner:d},h)=>{const f=j(h)?{params:l,req:{rs(v){},rj(v){}}}:l;return h.meta||(h.meta={fxID:ht()}),U({target:d,params:f,defer:1,scope:C(h),meta:h.meta}),f.params})),r.create=l=>{const d=ot(),h={params:l,req:d};if($&&!ae){const f=$;d.req.finally(()=>{we(f)}).catch(()=>{})}return U({target:r,params:h,scope:$}),d.req};const m=r.inFlight=I(0,{serialize:"ignore",named:(O(r,"name")||r.graphite.id)+".inFlight"}).on(r,l=>l+1).on(i,l=>l-1).map({fn:l=>l,named:"inFlight"});B(i,"needFxCounter","dec"),B(r,"needFxCounter",1);const g=r.pending=m.map({fn:l=>l>0,named:"pending"});return _e(r,[i,c,u,s,b,g,m]),n!=null&&n.domain&&n.domain.hooks.effect(r),r}function Xt(e,{scope:t,safe:n}={}){M(t||$||n,"scopeBind: scope not found");const a=t||$;return r=>{function o(){we(u)}let i,c=0;const u=$;we(a);try{i=e(r)}catch(s){i=s,c=1}if(o(),c)throw i;return i instanceof Promise&&i.then(o,o),i}}function Yt({unit:e,fn:t,scope:n,batch:a}){const r=[re.run({fn:i=>t(i)})];a&&r.unshift(re.compute({priority:"sampler",batch:1})),ee(e)&&r.unshift(re.mov({store:e.stateRef,to:"stack"}));const o=Array.isArray(e)?e:[e];if(n){const i=[],c=n.additionalLinks;return o.forEach(u=>{const s=c[u.graphite.id]||[];c[u.graphite.id]=s;const b=L({node:it(r,u),meta:{watchOp:u.kind}});s.push(b),i.push(()=>{const y=s.indexOf(b);y!==-1&&s.splice(y,1),Ae(b)})}),ke(()=>{i.forEach(u=>u())})}{const i=L({node:r,parent:o,family:{owners:o}});return ke(()=>{Ae(i)})}}function it(e,t){return ee(t)?[re.mov({store:t.stateRef,to:"stack"}),...e]:e}const ct=typeof Symbol<"u"&&Symbol.observable||"@@observable",D=e=>e.graphite||e,le=e=>e.family.owners,de=e=>e.family.links,se=e=>e.stateRef,K=e=>e.value,ie=e=>e.subscribers,j=e=>e.parent,C=e=>e.scope,O=(e,t)=>D(e).meta[t],B=(e,t,n)=>D(e).meta[t]=n,lt=e=>e.compositeName,fe=e=>(z(e)||F(e))&&"kind"in e,Y=e=>t=>fe(t)&&t.kind===e,ee=Y("store"),dt=Y("event"),Ee=Y("effect"),ft=e=>fe(e)&&!!e.targetable,Ce=Y("domain"),ut=Y("scope");var en={__proto__:null,unit:fe,store:ee,event:dt,effect:Ee,targetable:ft,domain:Ce,scope:ut,attached:e=>Ee(e)&&O(e,"attached")==1};const ge=(e,t)=>{const n=e.indexOf(t);n!==-1&&e.splice(n,1)},E=(e,t)=>e.push(t),ce=(e,t,n,a)=>!e&&console.error(`${a?a+": ":""}${t} is deprecated${n?`, use ${n} instead`:""}`),ue=()=>{let e=0;return()=>""+ ++e},pt=ue(),Te=ue(),mt=ue(),ht=ue();let V=null;const Pe=e=>{},Ve=()=>V,gt=e=>(e&&V&&V.sidRoot&&(e=`${V.sidRoot}|${e}`),e),_e=(e,t)=>{const n=D(e);N(t,a=>{const r=D(a);n.family.type!=="domain"&&(r.family.type="crosslink"),E(le(r),n),E(de(n),r)})},te=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(D),F=e=>typeof e=="object"&&e!==null,z=e=>typeof e=="function",Q=e=>e===void 0,vt=e=>M(F(e)||z(e),"expect first argument be an object"),Be=(e,t,n,a)=>M(!(!F(e)&&!z(e)||!("family"in e)&&!("graphite"in e)),`${t}: expect ${n} to be a unit (store, event or effect)${a}`),bt=(e,t,n)=>{Array.isArray(e)?N(e,(a,r)=>Be(a,t,`${r} item of ${n}`,"")):Be(e,t,n," or array of units")},yt=(e,{fn:t},{a:n})=>t(e,n),kt=(e,{fn:t},{a:n})=>t(n,e),pe=(e,{fn:t})=>t(e),We=(e,t,n,a)=>{const r={id:Te(),type:e,data:t};return n&&(r.order={priority:n},a&&(r.order.barrierID=++St)),r};let St=0;const me=({from:e="store",store:t,target:n,to:a=n?"store":"stack",batch:r,priority:o})=>We("mov",{from:e,store:t,to:a,target:n},o,r),X=({fn:e,batch:t,priority:n,safe:a=0,filter:r=0,pure:o=0})=>We("compute",{fn:e,safe:a,filter:r,pure:o},n,t),Ne=({fn:e})=>X({fn:e,priority:"effect"}),W=(e,t,n)=>X({fn:e,safe:1,filter:t,priority:n&&"effect"}),$t=(e,t,n)=>me({store:e,to:"a",priority:n,batch:1}),T=(e=pe,t)=>X({fn:e,pure:1,filter:t}),re={mov:me,compute:X,filter:({fn:e,pure:t})=>X({fn:e,filter:1,pure:t}),run:Ne},wt=e=>({id:Te(),current:e,initial:e}),je=({current:e})=>e,xt=(e,t)=>{e.before||(e.before=[]),E(e.before,t)};let P=null;const ze=(e,t)=>{if(!e)return t;if(!t)return e;let n;return(e.v.type===t.v.type&&e.v.id>t.v.id||$e(e.v.type)>$e(t.v.type))&&(n=e,e=t,t=n),n=ze(e.r,t),e.r=e.l,e.l=n,e},Ie=[];let Le=0;for(;Le<6;)E(Ie,{first:null,last:null,size:0}),Le+=1;const At=()=>{for(let e=0;e<6;e++){const t=Ie[e];if(t.size>0){if(e===3||e===4){t.size-=1;const a=P.v;return P=ze(P.l,P.r),a}t.size===1&&(t.last=null);const n=t.first;return t.first=n.r,t.size-=1,n.v}}},q=(e,t,n,a,r,o,i)=>Se(0,{a:null,b:null,node:n,parent:a,value:r,page:t,scope:o,meta:i},e,0),Se=(e,t,n,a)=>{const r=$e(n),o=Ie[r],i={v:{idx:e,stack:t,type:n,id:a},l:null,r:null};r===3||r===4?P=ze(P,i):(o.size===0?o.first=i:o.last.r=i,o.last=i),o.size+=1},$e=e=>{switch(e){case"child":return 0;case"pure":return 1;case"read":return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},ve=new Set;let $,ne=1,ae=0,oe=0,R=null;const we=e=>{$=e},qe=e=>{R=e},Ge=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=e.parent;if(e)return e}return null},Mt=(e,t,n,a)=>{const r=Ge(e,n.id);return r?r.reg[n.id]:t?(G(t,n,a),t.reg[n.id]):n},_t=e=>e,G=(e,t,n,a,r)=>{const o=e.reg;if(o[t.id])return;const i=t.sid,c={id:t.id,current:t.initial,meta:t.meta};if(c.id in e.values.idMap)c.current=e.values.idMap[c.id];else if(i&&i in e.values.sidMap&&!(i in e.sidIdMap)){var u;const s=t==null||(u=t.meta)===null||u===void 0?void 0:u.serialize;c.current=(e.fromSerialize&&s!=="ignore"&&(s==null?void 0:s.read)||_t)(e.values.sidMap[i])}else if(t.before&&!r){let s=0;const b=n||!t.noInit||a;N(t.before,y=>{switch(y.type){case"map":{const m=y.from;if((m||y.fn)&&(m&&G(e,m,n,a),b)){const g=m&&o[m.id].current;c.current=y.fn?y.fn(g):g}break}case"field":G(e,y.from,n,a),s||(s=1,c.current=Array.isArray(c.current)?[...c.current]:{...c.current}),b&&(c.current[y.field]=o[o[y.from.id].id].current)}})}i&&(e.sidIdMap[i]=t.id),o[t.id]=c},Nt=(e,t,n)=>{try{return t(K(n),e.scope,n)}catch(a){console.error(a),e.fail=1,e.failReason=a}},Z=(e,t={})=>(F(e)&&(Z(e.or,t),rt(e,(n,a)=>{Q(n)||a==="or"||a==="and"||(t[a]=n)}),Z(e.and,t)),t),Oe=(e,t)=>{ge(e.next,t),ge(le(e),t),ge(de(e),t)},xe=(e,t,n)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let r=de(e);for(;a=r.pop();)Oe(a,e),(t||n&&e.meta.op!=="sample"||a.family.type==="crosslink")&&xe(a,t,a.meta.op!=="on"&&n);for(r=le(e);a=r.pop();)Oe(a,e),n&&a.family.type==="crosslink"&&xe(a,t,a.meta.op!=="on"&&n)},H=e=>e.clear(),Ae=(e,{deep:t}={})=>{let n=0;if(e.ownerSet&&e.ownerSet.delete(e),ee(e))H(ie(e));else if(Ce(e)){n=1;const a=e.history;H(a.events),H(a.effects),H(a.stores),H(a.domains)}xe(D(e),!!t,n)},Ze=e=>ke(()=>Ae(e)),Re=(e,t,n,a,r)=>L({node:n,parent:e,child:t,scope:{fn:r},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),He=(e,t)=>(M(z(t),".watch argument should be a function"),Ze(L({scope:{fn:t},node:[Ne({fn:pe})],parent:e,meta:{op:"watch"},family:{owners:e},regional:1}))),zt=(e,t,n="event")=>{j(e)&&j(e).hooks[n](t)},Je=(e,t,n)=>{const a=Z(n),r=e==="domain",o=pt(),{sid:i=null,named:c=null,domain:u=null,parent:s=u}=a,b=c||a.name||(r?"":o),y=at(b,s),m={op:t.kind=e,name:t.shortName=b,sid:t.sid=gt(i),named:c,unitId:t.id=o,serialize:a.serialize,derived:a.derived,config:a};return t.targetable=!a.derived,t.parent=s,t.compositeName=y,t.defaultConfig=a,t.getType=()=>(ce(0,"getType","compositeName.fullName"),y.fullName),!r&&(t.subscribe=g=>(vt(g),t.watch(z(g)?g:l=>g.next&&g.next(l))),t[ct]=()=>t),m},be=(e,t,n,a)=>{let r;F(n)&&(r=n,n=n.fn);const o=_({name:`${e.shortName} → *`,derived:1,and:r});return Re(e,o,a,t,n),o},ye="undefined is used to skip updates. To allow undefined as a value provide explicit { skipVoid: false } option",Ke=(e,t,n,a,r)=>{const o=se(t),i=me({store:o,to:"a",priority:"read"});n==="map"&&(i.data.softRead=1);const c=[i,T(a)];return J("storeOnMap",o,c,ee(e)&&se(e)),Re(e,t,c,n,r)},It=(e,t,n)=>{try{return[1,e(...n)]}catch(a){return t(a),[0,null]}},Fe=(e,t,n,a,r)=>o=>{U({target:[a,Rt],params:[n?{status:"done",params:e,result:o}:{status:"fail",params:e,error:o},{value:o,fn:n?t.rs:t.rj}],defer:1,page:r.page,scope:r.scope,meta:r.meta})},Rt=L({node:[Ne({fn:({fn:e,value:t})=>e(t)})],meta:{op:"fx",fx:"sidechain"}}),Dt=I(null,{name:"settings"}),Et=I(null,{name:"game-analysis-id"}),Bt=_(),Lt=I(Ye(),{name:"board-width"}),qt=I(et(),{name:"tablet-board-width"}),Ot=I(tt(),{name:"mpv-lines"}),Ft=I(!0,{name:"is-delete-move-disabled"}),Ct=I(!0,{name:"annotations-visible"}),Tt=_();Ot.on(Tt,(e,t)=>(t.isStore&&localStorage.setItem(Qe,t.lines.toString()),t.lines));const Pt=_(),Vt=_(),Wt=_(),jt=_(),Gt=_();Ct.on(Gt,(e,t)=>t);Ft.on(jt,(e,t)=>t);Et.on(Wt,(e,t)=>t);Lt.on(Pt,(e,t)=>(localStorage.setItem(Ue,t.toString()),t));qt.on(Vt,(e,t)=>(localStorage.setItem(Xe,t.toString()),t));Dt.on(Bt,(e,t)=>e||t);const Zt=I(null,{name:"stockfish-available"}),Ht=st(async()=>await nt());Zt.on(Ht.done,(e,{result:t})=>e||t);const Jt=I(!1,{name:"need-save"}),Kt=_();Jt.on(Kt,(e,t)=>t);export{Lt as $,Yt as D,Xt as F,Dt as a,en as b,jt as c,I as h,_ as p,Gt as s};
