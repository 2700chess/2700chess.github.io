function Ue(e,t){for(const n in e)t(e[n],n)}function M(e,t){e.forEach(t)}function z(e,t,n){if(!e)throw Error(`${n?n+": ":""}${t}`)}function C({node:e=[],from:t,source:n,parent:a=t||n,to:r,target:o,child:i=r||o,scope:c={},meta:u={},family:s={type:"regular"},regional:v}={}){const b=ee(a),m=ee(s.links),g=ee(s.owners),l=[];M(e,h=>h&&F(l,h));const f={id:st(),seq:l,next:ee(i),meta:u,scope:c,family:{type:s.type||"crosslink",links:m,owners:g}};return M(m,h=>F(ce(h),f)),M(g,h=>F(le(h),f)),M(b,h=>F(h.next,f)),v&&_&&ze(K(_),[f]),f}function U(e,t,n){let a,r=R,o=null,i=$;if(e.target&&(t=e.params,n=e.defer,a=e.meta,r="page"in e?e.page:r,e.stack&&(o=e.stack),i=j(e)||i,e=e.target),i&&$&&i!==$&&($=null),Array.isArray(e))for(let l=0;l<e.length;l++)D("pure",r,q(e[l]),o,t[l],i,a);else D("pure",r,q(e),o,t,i,a);if(n&&!te)return;const c={isRoot:te,currentPage:R,scope:$,isWatch:re,isPure:ae};let u,s,v,b,m,g;te=0;e:for(;b=yt();){const{idx:l,stack:f,type:h}=b;v=f.node,R=m=f.page,$=j(f),m?g=m.reg:$&&(g=$.reg);const d=!!m,y=!!$,k={fail:0,scope:v.scope};u=s=0;for(let S=l;S<v.seq.length&&!u;S++){const w=v.seq[S];if(w.order){const{priority:x,barrierID:p}=w.order,N=p?m?`${m.fullID}_${p}`:p:0;if(S!==l||h!==x){p?ge.has(N)||(ge.add(N),ke(S,f,x,p)):ke(S,f,x,0);continue e}p&&ge.delete(N)}switch(w.type){case"mov":{const p=w.data;let N;switch(p.from){case"stack":N=K(f);break;case"a":case"b":N=f[p.from];break;case"value":N=p.store;break;case"store":if(g&&!g[p.store.id])if(d){const me=Ge(m,p.store.id);f.page=m=me,me?g=me.reg:y?(L($,p.store,0,1,p.softRead),g=$.reg):g=void 0}else y&&L($,p.store,0,1,p.softRead);N=Le(g&&g[p.store.id]||p.store)}switch(p.to){case"stack":f.value=N;break;case"a":case"b":f[p.to]=N;break;case"store":vt(m,$,p.target,0).current=N}break}case"compute":const x=w.data;if(x.fn){re=v.meta.op==="watch",ae=x.pure;const p=x.safe?(0,x.fn)(K(f),k.scope,f):kt(k,x.fn,f);x.filter?s=!p:f.value=p,re=c.isWatch,ae=c.isPure}}u=k.fail||s}if(!u){const S=K(f),w=j(f);if(M(v.next,x=>{D("child",m,x,f,S,w)}),w){v.meta.needFxCounter&&D("child",m,w.fxCount,f,S,w),v.meta.storeChange&&D("child",m,w.storeChange,f,S,w),v.meta.warnSerialize&&D("child",m,w.warnSerializeNode,f,S,w);const x=w.additionalLinks[v.id];x&&M(x,p=>{D("child",m,p,f,S,w)})}}}te=c.isRoot,R=c.currentPage,$=j(c)}function Xe(e,t){let n,a;const r=e;if(t){const o=tt(t);e.length===0?(n=o.path,a=o.fullName):(n=o.path.concat([e]),a=o.fullName.length===0?e:o.fullName+"/"+e)}else n=e.length===0?[]:[e],a=e;return{shortName:r,fullName:a,path:n}}function Ne(e,t){if(!t||!t.name&&!t.named&&!t.loc)return e;let n=`[${e}]`;const a=t.named||t.name;a&&(n+=` unit '${a}'`);const r=t.loc;return!a&&r&&(n+=` (${r.file}:${r.line}:${r.column})`),n}function be(e){const t=()=>e();return t.unsubscribe=()=>e(),t}function J(e,...t){const n=We();if(n){const a=n.handlers[e];if(a)return a(n,...t)}}function W(e,t){const n=G({or:t,and:typeof e=="string"?{name:e}:e}),a=Ne("event",n),r=(c,...u)=>(z(!O(r,"derived"),"call of derived event is not supported, use createEvent instead",a),z(!ae,"unit call from pure function is not supported, use operators like sample instead",a),R?((s,v,b,m)=>{const g=R;let l=null;if(v)for(l=R;l&&l.template!==v;)l=B(l);Oe(l);const f=s.create(b,m);return Oe(g),f})(r,o,c,u):r.create(c,u)),o=We(),i=Object.assign(r,{graphite:C({meta:Ke(n.actualOp||"event",r,n),regional:1}),create:c=>(U({target:r,params:c,scope:$}),c),watch:c=>Je(r,c),map:c=>ye(r,"map",c,[E()]),filter:c=>ye(r,"filter",c.fn?c:c.fn,[E(ue,1)]),filterMap:c=>ye(r,"filterMap",c,[E(),T(u=>!Q(u),1)]),prepend(c){z(r.targetable,".prepend of derived event is not supported, call source event instead",a);const u=W("* → "+r.shortName,{parent:B(r)});return J("eventPrepend",q(u)),qe(u,r,[E()],"prepend",c),wt(r,u),u}});return n!=null&&n.domain&&n.domain.hooks.event(i),I(i,"id",i.graphite.id),Te(i.graphite),i}function Fe(e,t,n,a,r){return ft(n,`${r} ${t}`,"first argument"),z(A(a),"second argument should be a function",r),ie(!O(e,"derived"),`${t} in derived store`,`${t} in store created via createStore`,r),M(Array.isArray(n)?n:[n],o=>{e.off(o),se(e).set(o,He(Qe(o,e,"on",ut,a)))}),e}function Ee(e,t){const n=G(t),a=ht(e),r=Ne("store",n),o=W({named:"updates",derived:1});J("storeBase",a);const i=a.id,c="skipVoid"in n,u=c&&!n.skipVoid;ie(!(c&&n.skipVoid),"{skipVoid: true}","updateFilter",r);const s={subscribers:new Map,updates:o,defaultState:e,stateRef:a,getState(){let d,y=a;if(R){let k=R;for(;k&&!k.reg[i];)k=B(k);k&&(d=k)}return!d&&$&&(L($,a,1),d=$),d&&(y=d.reg[i]),Le(y)},setState:d=>U({target:s,params:d,defer:1,scope:$}),reset:(...d)=>(z(s.targetable,".reset of derived store is not supported",r),M(d,y=>Fe(s,".reset",y,()=>s.defaultState,r)),s),on:(d,y)=>(z(s.targetable,".on of derived store is not supported",r),Fe(s,".on",d,y,r)),off(d){const y=se(s).get(d);return y&&(y(),se(s).delete(d)),s},map(d,y){let k,S;P(d)&&(k=d,d=d.fn);const w=s.getState(),x=Q(w);(!x||x&&u)&&(S=d(w));const p=Ee(S,{name:`${s.shortName} → *`,derived:1,...y,and:k}),N=Qe(s,p,"map",ue,d);return gt(oe(p),{type:"map",fn:d,from:a}),oe(p).noInit=1,J("storeMap",a,N),p},watch(d,y){if(ie(!y,"watch second argument","sample",r),!y||!fe(d)){const k=Je(s,d);return J("storeWatch",a,d)||d(s.getState()),k}return z(A(y),"second argument should be a function",r),d.watch(k=>y(s.getState(),k))}},v=Ke("store",s,n),b=s.defaultConfig.updateFilter;s.graphite=C({scope:{state:a,fn:b},node:[T((d,y,k)=>(k.scope&&!k.scope.reg[a.id]&&(k.b=1),d)),mt(a),T((d,y,{a:k,b:S})=>{const w=Q(d);return w&&!c&&console.error(`${r}: ${ve}`),(w&&u||!w)&&(d!==k||S)},1),b&&E(dt,1),pe({from:"stack",target:a})],child:o,meta:{...v,defaultState:e},regional:1}),I(s,"id",s.graphite.id),I(s,"rootStateRefId",i);const m=O(s,"serialize"),g=O(s,"derived"),l=m==="ignore",f=O(s,"sid");f&&(I(s,"storeChange",1),a.sid=f),f||l||g||I(s,"warnSerialize",1);const h=Q(e);return z(g||!h||h&&u,ve,r),g&&h&&!c&&console.error(`${r}: ${ve}`),ze(s,[o]),n!=null&&n.domain&&n.domain.hooks.store(s),g||(s.reinit=W({named:"reinit"}),s.reset(s.reinit)),a.meta=s.graphite.meta,Te(s.graphite),s}function Ye(){const e={};return e.req=new Promise((t,n)=>{e.rs=t,e.rj=n}),e.req.catch(()=>{}),e}function St(e,t={}){const n=G(A(e)?{handler:e}:e,t),a=Ne("effect",n),r=W(A(e)?{handler:e}:e,{...t,actualOp:"effect"}),o=q(r);I(o,"op",r.kind="effect"),r.use=l=>(z(A(l),".use argument should be a function",a),b.scope.handler=l,r),r.use.getCurrent=()=>b.scope.handler;const i=r.finally=W({named:"finally",derived:1}),c=r.done=i.filterMap({named:"done",fn({status:l,params:f,result:h}){if(l==="done")return{params:f,result:h}}}),u=r.fail=i.filterMap({named:"fail",fn({status:l,params:f,error:h}){if(l==="fail")return{params:f,error:h}}}),s=r.doneData=c.map({named:"doneData",fn:({result:l})=>l}),v=r.failData=u.map({named:"failData",fn:({error:l})=>l}),b=C({scope:{handler:r.defaultConfig.handler||(()=>z(0,`no handler used in ${r.compositeName.fullName}`))},node:[T((l,f,h)=>{let d=f.handler;const y=j(h);if(y){const k=y.handlers.unitMap.get(r)||y.handlers.sidMap[r.sid];k&&(d=k)}return l.handler=d,l},0,1),T((l,f,h)=>{if(f.runnerFn&&!f.runnerFn(l,null,h))return;const{params:d,req:y,handler:k,args:S=[d]}=l,w=je(d,y,1,i,h),x=je(d,y,0,i,h),[p,N]=$t(k,x,S);p&&(P(N)&&A(N.then)?N.then(w,x):w(N))},0,1)],meta:{op:"fx",fx:"runner"}});o.scope.runner=b,F(o.seq,T((l,{runner:f},h)=>{const d=B(h)?{params:l,req:{rs(y){},rj(y){}}}:l;return h.meta||(h.meta={fxID:it()}),U({target:f,params:d,defer:1,scope:j(h),meta:h.meta}),d.params})),r.create=l=>{const f=Ye(),h={params:l,req:f};if($&&!re){const d=$;f.req.finally(()=>{$e(d)}).catch(()=>{})}return U({target:r,params:h,scope:$}),f.req};const m=r.inFlight=Ee(0,{serialize:"ignore",named:(O(r,"name")||r.graphite.id)+".inFlight"}).on(r,l=>l+1).on(i,l=>l-1).map({fn:l=>l,named:"inFlight"});I(i,"needFxCounter","dec"),I(r,"needFxCounter",1);const g=r.pending=m.map({fn:l=>l>0,named:"pending"});return ze(r,[i,c,u,s,v,g,m]),n!=null&&n.domain&&n.domain.hooks.effect(r),r}function Nt(e,{scope:t,safe:n}={}){z(t||$||n,"scopeBind: scope not found");const a=t||$;return r=>{function o(){$e(u)}let i,c=0;const u=$;$e(a);try{i=e(r)}catch(s){i=s,c=1}if(o(),c)throw i;return i instanceof Promise&&i.then(o,o),i}}function zt({unit:e,fn:t,scope:n,batch:a}){const r=[ne.run({fn:i=>t(i)})];a&&r.unshift(ne.compute({priority:"sampler",batch:1})),Z(e)&&r.unshift(ne.mov({store:e.stateRef,to:"stack"}));const o=Array.isArray(e)?e:[e];if(n){const i=[],c=n.additionalLinks;return o.forEach(u=>{const s=c[u.graphite.id]||[];c[u.graphite.id]=s;const v=C({node:Ze(r,u),meta:{watchOp:u.kind}});s.push(v),i.push(()=>{const b=s.indexOf(v);b!==-1&&s.splice(b,1),Se(v)})}),be(()=>{i.forEach(u=>u())})}{const i=C({node:r,parent:o,family:{owners:o}});return be(()=>{Se(i)})}}function Ze(e,t){return Z(t)?[ne.mov({store:t.stateRef,to:"stack"}),...e]:e}const et=typeof Symbol<"u"&&Symbol.observable||"@@observable",q=e=>e.graphite||e,ce=e=>e.family.owners,le=e=>e.family.links,oe=e=>e.stateRef,K=e=>e.value,se=e=>e.subscribers,B=e=>e.parent,j=e=>e.scope,O=(e,t)=>q(e).meta[t],I=(e,t,n)=>q(e).meta[t]=n,tt=e=>e.compositeName,fe=e=>(A(e)||P(e))&&"kind"in e,Y=e=>t=>fe(t)&&t.kind===e,Z=Y("store"),nt=Y("event"),Ie=Y("effect"),rt=e=>fe(e)&&!!e.targetable,Ve=Y("domain"),at=Y("scope");var Mt={__proto__:null,unit:fe,store:Z,event:nt,effect:Ie,targetable:rt,domain:Ve,scope:at,attached:e=>Ie(e)&&O(e,"attached")==1};const he=(e,t)=>{const n=e.indexOf(t);n!==-1&&e.splice(n,1)},F=(e,t)=>e.push(t),ie=(e,t,n,a)=>!e&&console.error(`${a?a+": ":""}${t} is deprecated${n?`, use ${n} instead`:""}`),de=()=>{let e=0;return()=>""+ ++e},ot=de(),_e=de(),st=de(),it=de();let _=null;const Te=e=>{},We=()=>_,ct=e=>(e&&_&&_.sidRoot&&(e=`${_.sidRoot}|${e}`),e),ze=(e,t)=>{const n=q(e);M(t,a=>{const r=q(a);n.family.type!=="domain"&&(r.family.type="crosslink"),F(ce(r),n),F(le(n),r)})},ee=(e=[])=>(Array.isArray(e)?e:[e]).flat().map(q),P=e=>typeof e=="object"&&e!==null,A=e=>typeof e=="function",Q=e=>e===void 0,lt=e=>z(P(e)||A(e),"expect first argument be an object"),Ce=(e,t,n,a)=>z(!(!P(e)&&!A(e)||!("family"in e)&&!("graphite"in e)),`${t}: expect ${n} to be a unit (store, event or effect)${a}`),ft=(e,t,n)=>{Array.isArray(e)?M(e,(a,r)=>Ce(a,t,`${r} item of ${n}`,"")):Ce(e,t,n," or array of units")},dt=(e,{fn:t},{a:n})=>t(e,n),ut=(e,{fn:t},{a:n})=>t(n,e),ue=(e,{fn:t})=>t(e),Be=(e,t,n,a)=>{const r={id:_e(),type:e,data:t};return n&&(r.order={priority:n},a&&(r.order.barrierID=++pt)),r};let pt=0;const pe=({from:e="store",store:t,target:n,to:a=n?"store":"stack",batch:r,priority:o})=>Be("mov",{from:e,store:t,to:a,target:n},o,r),X=({fn:e,batch:t,priority:n,safe:a=0,filter:r=0,pure:o=0})=>Be("compute",{fn:e,safe:a,filter:r,pure:o},n,t),Me=({fn:e})=>X({fn:e,priority:"effect"}),T=(e,t,n)=>X({fn:e,safe:1,filter:t,priority:n&&"effect"}),mt=(e,t,n)=>pe({store:e,to:t?"stack":"a",priority:n&&"sampler",batch:1}),E=(e=ue,t)=>X({fn:e,pure:1,filter:t}),ne={mov:pe,compute:X,filter:({fn:e,pure:t})=>X({fn:e,filter:1,pure:t}),run:Me},ht=e=>({id:_e(),current:e,initial:e}),Le=({current:e})=>e,gt=(e,t)=>{e.before||(e.before=[]),F(e.before,t)};let V=null;const Ae=(e,t)=>{if(!e)return t;if(!t)return e;let n;return(e.v.type===t.v.type&&e.v.id>t.v.id||we(e.v.type)>we(t.v.type))&&(n=e,e=t,t=n),n=Ae(e.r,t),e.r=e.l,e.l=n,e},Re=[];let De=0;for(;De<6;)F(Re,{first:null,last:null,size:0}),De+=1;const yt=()=>{for(let e=0;e<6;e++){const t=Re[e];if(t.size>0){if(e===3||e===4){t.size-=1;const a=V.v;return V=Ae(V.l,V.r),a}t.size===1&&(t.last=null);const n=t.first;return t.first=n.r,t.size-=1,n.v}}},D=(e,t,n,a,r,o,i)=>ke(0,{a:null,b:null,node:n,parent:a,value:r,page:t,scope:o,meta:i},e,0),ke=(e,t,n,a)=>{const r=we(n),o=Re[r],i={v:{idx:e,stack:t,type:n,id:a},l:null,r:null};r===3||r===4?V=Ae(V,i):(o.size===0?o.first=i:o.last.r=i,o.last=i),o.size+=1},we=e=>{switch(e){case"child":return 0;case"pure":return 1;case"read":return 2;case"barrier":return 3;case"sampler":return 4;case"effect":return 5;default:return-1}},ge=new Set;let $,te=1,re=0,ae=0,R=null;const $e=e=>{$=e},Oe=e=>{R=e},Ge=(e,t)=>{if(e){for(;e&&!e.reg[t];)e=e.parent;if(e)return e}return null},vt=(e,t,n,a)=>{const r=Ge(e,n.id);return r?r.reg[n.id]:t?(L(t,n,a),t.reg[n.id]):n},bt=e=>e,L=(e,t,n,a,r)=>{const o=e.reg;if(o[t.id])return;const i=t.sid,c={id:t.id,current:t.initial,meta:t.meta};if(c.id in e.values.idMap)c.current=e.values.idMap[c.id];else if(i&&i in e.values.sidMap&&!(i in e.sidIdMap)){var u;const s=t==null||(u=t.meta)===null||u===void 0?void 0:u.serialize;c.current=(e.fromSerialize&&s!=="ignore"&&(s==null?void 0:s.read)||bt)(e.values.sidMap[i])}else if(t.before&&!r){let s=0;const v=n||!t.noInit||a;M(t.before,b=>{switch(b.type){case"map":{const m=b.from;if((m||b.fn)&&(m&&L(e,m,n,a),v)){const g=m&&o[m.id].current;c.current=b.fn?b.fn(g):g}break}case"field":L(e,b.from,n,a),s||(s=1,c.current=Array.isArray(c.current)?[...c.current]:{...c.current}),v&&(c.current[b.field]=o[o[b.from.id].id].current)}})}i&&(e.sidIdMap[i]=t.id),o[t.id]=c},kt=(e,t,n)=>{try{return t(K(n),e.scope,n)}catch(a){console.error(a),e.fail=1,e.failReason=a}},G=(e,t={})=>(P(e)&&(G(e.or,t),Ue(e,(n,a)=>{Q(n)||a==="or"||a==="and"||(t[a]=n)}),G(e.and,t)),t),Pe=(e,t)=>{he(e.next,t),he(ce(e),t),he(le(e),t)},xe=(e,t,n)=>{let a;e.next.length=0,e.seq.length=0,e.scope=null;let r=le(e);for(;a=r.pop();)Pe(a,e),(t||n&&e.meta.op!=="sample"||a.family.type==="crosslink")&&xe(a,t,a.meta.op!=="on"&&n);for(r=ce(e);a=r.pop();)Pe(a,e),n&&a.family.type==="crosslink"&&xe(a,t,a.meta.op!=="on"&&n)},H=e=>e.clear(),Se=(e,{deep:t}={})=>{let n=0;if(e.ownerSet&&e.ownerSet.delete(e),Z(e))H(se(e));else if(Ve(e)){n=1;const a=e.history;H(a.events),H(a.effects),H(a.stores),H(a.domains)}xe(q(e),!!t,n)},He=e=>be(()=>Se(e)),qe=(e,t,n,a,r)=>C({node:n,parent:e,child:t,scope:{fn:r},meta:{op:a},family:{owners:[e,t],links:t},regional:1}),Je=(e,t)=>(z(A(t),".watch argument should be a function"),He(C({scope:{fn:t},node:[Me({fn:ue})],parent:e,meta:{op:"watch"},family:{owners:e},regional:1}))),wt=(e,t,n="event")=>{B(e)&&B(e).hooks[n](t)},Ke=(e,t,n)=>{const a=G(n),r=e==="domain",o=ot(),{sid:i=null,named:c=null,domain:u=null,parent:s=u}=a,v=c||a.name||(r?"":o),b=Xe(v,s),m={op:t.kind=e,name:t.shortName=v,sid:t.sid=ct(i),named:c,unitId:t.id=o,serialize:a.serialize,derived:a.derived,config:a};return t.targetable=!a.derived,t.parent=s,t.compositeName=b,t.defaultConfig=a,t.getType=()=>(ie(0,"getType","compositeName.fullName"),b.fullName),!r&&(t.subscribe=g=>(lt(g),t.watch(A(g)?g:l=>g.next&&g.next(l))),t[et]=()=>t),m},ye=(e,t,n,a)=>{let r;P(n)&&(r=n,n=n.fn);const o=W({name:`${e.shortName} → *`,derived:1,and:r});return qe(e,o,a,t,n),o},ve="undefined is used to skip updates. To allow undefined as a value provide explicit { skipVoid: false } option",Qe=(e,t,n,a,r)=>{const o=oe(t),i=pe({store:o,to:"a",priority:"read"});n==="map"&&(i.data.softRead=1);const c=[i,E(a)];return J("storeOnMap",o,c,Z(e)&&oe(e)),qe(e,t,c,n,r)},$t=(e,t,n)=>{try{return[1,e(...n)]}catch(a){return t(a),[0,null]}},je=(e,t,n,a,r)=>o=>{U({target:[a,xt],params:[n?{status:"done",params:e,result:o}:{status:"fail",params:e,error:o},{value:o,fn:n?t.rs:t.rj}],defer:1,page:r.page,scope:r.scope,meta:r.meta})},xt=C({node:[Me({fn:({fn:e,value:t})=>e(t)})],meta:{op:"fx",fx:"sidechain"}});export{zt as D,Nt as F,Mt as a,St as b,Ee as h,W as p};
